<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>母音回文生成補助ツール | Creative Canvas</title>
    <meta name="description" content="日本語の「母音回文」の創作を支援するインタラクティブなツール。中心の母音列を軸に、順方向と逆方向の文を同時に構築できます。">
    <meta name="page:icon" content="fas fa-arrows-left-right-to-line">
    <meta name="page:color" content="#6366f1">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scrollbar-width: thin;
            scrollbar-color: #a5b4fc #e0e7ff;
            background-color: #f8fafc;
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e7ff;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a5b4fc;
            border-radius: 10px;
            border: 2px solid #e0e7ff;
        }

        .loader {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 3px solid;
            border-color: #d1d5db #d1d5db transparent transparent;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader::after,
        .loader::before {
            content: '';  
            box-sizing: border-box;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid;
            border-color: transparent transparent #6366f1 #6366f1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-sizing: border-box;
            animation: rotationBack 0.5s linear infinite;
            transform-origin: center center;
        }
        .loader::before {
            width: 28px;
            height: 28px;
            border-color: #d1d5db #d1d5db transparent transparent;
            animation: rotation 1.5s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } 
        @keyframes rotationBack {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-360deg); }
        }
        
        .vowel-char {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .word-chip {
            animation: pop-in 0.3s ease-out forwards;
        }

        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .sentence-container {
            scrollbar-width: thin;
            scrollbar-color: #c7d2fe #eef2ff;
        }

        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
    </style>
</head>

<body class="bg-slate-50 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <div class="loader"></div>
        <p id="loading-text" class="mt-6 text-gray-700 font-medium text-lg">辞書データを準備しています...</p>
        <div class="w-64 bg-gray-200 rounded-full h-2 mt-4 overflow-hidden">
            <div id="loading-progress" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <div id="app-container" class="flex flex-col h-screen opacity-0 transition-opacity duration-500 p-4 sm:p-6 md:p-8">
        
        <header class="flex-shrink-0 flex flex-col sm:flex-row justify-between items-center pb-4 mb-4 border-b-2 border-gray-200">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <i class="fas fa-arrows-left-right-to-line text-3xl gradient-text"></i>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">母音回文 生成補助ツール</h1>
                    <p class="text-sm text-gray-500">Vowel Palindrome Assistant</p>
                </div>
            </div>
            <div id="initial-controls" class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative flex-grow">
                    <i class="fas fa-pencil-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="start-word-input" placeholder="開始単語 (例: 私)" class="w-full pl-9 pr-4 py-2 text-base bg-white border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 outline-none transition-all duration-300">
                </div>
                <button id="start-button" class="bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-600 active:bg-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg transform active:scale-95 whitespace-nowrap">
                    <i class="fas fa-play mr-2"></i>開始
                </button>
                <button id="reset-button" class="bg-gray-200 text-gray-600 font-bold py-2 px-5 rounded-lg hover:bg-gray-300 transition-colors duration-200 whitespace-nowrap hidden">
                     <i class="fas fa-undo mr-2"></i>リセット
                </button>
            </div>
        </header>

        <main id="main-content" class="flex-grow flex flex-col items-center justify-center transition-all duration-500">
            <div id="welcome-message" class="text-center p-8">
                <i class="fas fa-feather-alt text-6xl text-gray-300 mb-6"></i>
                <h2 class="text-3xl font-bold text-gray-700">創作を始めよう</h2>
                <p class="mt-2 max-w-md text-gray-500">上のボックスに最初の単語を入力して「開始」ボタンを押してください。入力された単語を元に、母音のキャンバスが生成されます。</p>
            </div>

            <div id="palindrome-display" class="w-full flex-grow flex-col items-center justify-center gap-4 hidden">
                
                <div class="w-full p-4 bg-white/60 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">順方向の文 (EXPAND)</h3>
                        <span id="forward-vowel-count" class="text-sm font-mono text-gray-500"></span>
                    </div>
                    <div class="flex items-center gap-2">
                         <button data-action="forward-prepend" class="add-word-btn flex-shrink-0 w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full hover:bg-emerald-200 transition-all text-xl font-light">+</button>
                         <div id="forward-sentence-container" class="sentence-container flex-grow flex items-center gap-2 p-2 rounded-lg bg-gray-100 overflow-x-auto min-h-[52px]"></div>
                         <button data-action="forward-append" class="add-word-btn flex-shrink-0 w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full hover:bg-emerald-200 transition-all text-xl font-light">+</button>
                    </div>
                </div>

                <div class="w-full p-2 my-2 flex items-center justify-center">
                    <div id="vowel-sequence-container" class="flex items-center justify-center gap-1 p-3 rounded-lg flex-wrap bg-gradient-to-r from-gray-800 to-slate-700 shadow-inner"></div>
                </div>

                <div class="w-full p-4 bg-white/60 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">逆方向の文 (FILL)</h3>
                        <span id="backward-vowel-count" class="text-sm font-mono text-gray-500"></span>
                    </div>
                    <div class="flex items-center gap-2">
                         <button data-action="backward-prepend" class="add-word-btn flex-shrink-0 w-10 h-10 bg-sky-100 text-sky-600 rounded-full hover:bg-sky-200 transition-all text-xl font-light">+</button>
                         <div id="backward-sentence-container" class="sentence-container flex-grow flex items-center gap-2 p-2 rounded-lg bg-gray-100 overflow-x-auto min-h-[52px]"></div>
                         <button data-action="backward-append" class="add-word-btn flex-shrink-0 w-10 h-10 bg-sky-100 text-sky-600 rounded-full hover:bg-sky-200 transition-all text-xl font-light">+</button>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <div id="search-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex justify-center items-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out">
        <div id="modal-panel" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform opacity-0 scale-95 transition-all duration-300 ease-in-out">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800">単語を追加</h2>
                    <p id="modal-description" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-full w-9 h-9 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row items-center flex-wrap gap-4">
                <div id="modal-query-display" class="flex-grow">
                    <label class="text-xs font-bold text-gray-500">検索クエリ:</label>
                    <div class="font-mono text-indigo-600 bg-indigo-50 p-2 rounded-md border border-indigo-200 mt-1"></div>
                </div>
                 <div class="flex items-center gap-2" id="vowel-length-selector-container">
                    <label for="vowel-length-selector" class="text-sm text-gray-600 shrink-0">母音数:</label>
                    <input type="number" id="vowel-length-selector" value="3" min="1" max="20" class="w-20 text-sm bg-white border-gray-300 rounded-md py-1 px-2 focus:ring-indigo-300 focus:border-indigo-300">
                </div>
                <div class="flex items-center gap-2" id="modal-limit-selector-container">
                    <label for="modal-limit-selector" class="text-sm text-gray-600 shrink-0">表示件数:</label>
                    <input type="number" id="modal-limit-selector" value="50" min="10" max="500" step="10" class="w-20 text-sm bg-white border-gray-300 rounded-md py-1 px-2 focus:ring-indigo-300 focus:border-indigo-300">
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto" id="modal-search-box-container">
                    <div class="relative flex-grow">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="modal-search-input" placeholder="単語で絞り込み..." class="w-full pl-9 pr-4 py-2 text-base bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 outline-none transition-all duration-300">
                    </div>
                </div>
            </div>
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center mb-3">
                     <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">品詞フィルター</h3>
                     <div class="space-x-2">
                        <button id="filter-select-all" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">全選択</button>
                        <button id="filter-deselect-all" class="text-xs text-gray-500 hover:text-gray-800 font-medium">全解除</button>
                    </div>
                </div>
                <div id="modal-filter-list" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="modal-content" class="p-6 flex-grow overflow-y-auto space-y-4">
                <p class="text-center text-gray-500">検索結果がここに表示されます。</p>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] w-full max-w-xs"></div>

    <script>
        class TrieNode {
            constructor() {
                this.children = {};
                this.words = new Set();
            }
        }

        class Trie {
            constructor() {
                this.root = new TrieNode();
            }

            add(key, wordObject) {
                let node = this.root;
                for (const char of key) {
                    if (!node.children[char]) {
                        node.children[char] = new TrieNode();
                    }
                    node = node.children[char];
                }
                node.words.add(wordObject);
            }

            _collectAll(node) {
                let results = [...node.words];
                for (const char in node.children) {
                    results.push(...this._collectAll(node.children[char]));
                }
                return results;
            }

            searchPrefix(prefix) {
                let node = this.root;
                for (const char of prefix) {
                    if (!node.children[char]) {
                        return [];
                    }
                    node = node.children[char];
                }
                return this._collectAll(node);
            }
        }

        class YomiUtil {
             constructor() {
                this.kana_to_vowel = { "ア": "a", "イ": "i", "ウ": "u", "エ": "e", "オ": "o", "カ": "a", "キ": "i", "ク": "u", "ケ": "e", "コ": "o", "サ": "a", "シ": "i", "ス": "u", "セ": "e", "ソ": "o", "タ": "a", "チ": "i", "ツ": "u", "テ": "e", "ト": "o", "ナ": "a", "ニ": "i", "ヌ": "u", "ネ": "e", "ノ": "o", "ハ": "a", "ヒ": "i", "フ": "u", "ヘ": "e", "ホ": "o", "マ": "a", "ミ": "i", "ム": "u", "メ": "e", "モ": "o", "ヤ": "a", "ユ": "u", "ヨ": "o", "ラ": "a", "リ": "i", "ル": "u", "レ": "e", "ロ": "o", "ワ": "a", "ヲ": "o", "ン": "n", "ガ": "a", "ギ": "i", "グ": "u", "ゲ": "e", "ゴ": "o", "ザ": "a", "ジ": "i", "ズ": "u", "ゼ": "e", "ゾ": "o", "ダ": "a", "ヂ": "i", "ヅ": "u", "デ": "e", "ド": "o", "バ": "a", "ビ": "i", "ブ": "u", "ベ": "e", "ボ": "o", "パ": "a", "ピ": "i", "プ": "u", "ペ": "e", "ポ": "o", "ァ": "a", "ィ": "i", "ゥ": "u", "ェ": "e", "ォ": "o", "ャ": "a", "ュ": "u", "ョ": "o", "ッ": "", "ヴ": "u" };
            }
            getVowels(yomi) {
                if (!yomi) return [];
                const yomiKana = yomi.replace(/ー/g, ''); 
                let vowels = [];
                for (const char of yomiKana) {
                    if (this.kana_to_vowel[char] !== undefined) {
                        vowels.push(this.kana_to_vowel[char]);
                    }
                }
                return vowels;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingText: document.getElementById('loading-text'),
                loadingProgress: document.getElementById('loading-progress'),
                appContainer: document.getElementById('app-container'),
                mainContent: document.getElementById('main-content'),
                welcomeMessage: document.getElementById('welcome-message'),
                palindromeDisplay: document.getElementById('palindrome-display'),
                initialControls: document.getElementById('initial-controls'),
                startWordInput: document.getElementById('start-word-input'),
                startButton: document.getElementById('start-button'),
                resetButton: document.getElementById('reset-button'),
                forwardSentenceContainer: document.getElementById('forward-sentence-container'),
                backwardSentenceContainer: document.getElementById('backward-sentence-container'),
                vowelSequenceContainer: document.getElementById('vowel-sequence-container'),
                forwardVowelCount: document.getElementById('forward-vowel-count'),
                backwardVowelCount: document.getElementById('backward-vowel-count'),
                searchModal: {
                    container: document.getElementById('search-modal'),
                    panel: document.getElementById('modal-panel'),
                    title: document.getElementById('modal-title'),
                    description: document.getElementById('modal-description'),
                    closeBtn: document.getElementById('modal-close-btn'),
                    content: document.getElementById('modal-content'),
                    queryDisplay: document.querySelector('#modal-query-display div'),
                    vowelLengthSelectorContainer: document.getElementById('vowel-length-selector-container'),
                    vowelLengthSelector: document.getElementById('vowel-length-selector'),
                    searchBoxContainer: document.getElementById('modal-search-box-container'),
                    searchInput: document.getElementById('modal-search-input'),
                    filterList: document.getElementById('modal-filter-list'),
                    filterSelectAll: document.getElementById('filter-select-all'),
                    filterDeselectAll: document.getElementById('filter-deselect-all'),
                    modalLimitSelector: document.getElementById('modal-limit-selector'),
                },
                toastContainer: document.getElementById('toast-container'),
            };

            const YU = new YomiUtil();
            const forwardTrie = new Trie();
            const backwardTrie = new Trie();
            const wordDetailsMap = new Map();
            let state = null;
            let currentSearchContext = { rawResults: [] };
            
            const dictionaryConfig = {
                'Noun': { name: '名詞', color: 'blue' }, 'Verb': { name: '動詞', color: 'green' }, 'Adj': { name: '形容詞', color: 'pink' }, 'Adverb': { name: '副詞', color: 'purple' },
            };

            const csvList = [
                "../Assets/dict/Noun.csv", "../Assets/dict/Verb.csv", "../Assets/dict/Adj.csv", "../Assets/dict/Adverb.csv"
            ];
            
            class PalindromeState {
                constructor(startWord) {
                    this.forwardWords = [startWord];
                    this.backwardWords = [];
                    this.vowelSequence = [];
                    this.recalculateVowelSequence();
                }
                recalculateVowelSequence() { this.vowelSequence = this.forwardWords.flatMap(w => w.vowels); }
                getForwardVowels() { return this.forwardWords.flatMap(w => w.vowels); }
                getBackwardVowels() { return this.backwardWords.flatMap(w => w.vowels); }
                addWord(word, action) {
                    switch (action) {
                        case 'forward-prepend': this.forwardWords.unshift(word); this.recalculateVowelSequence(); break;
                        case 'forward-append': this.forwardWords.push(word); this.recalculateVowelSequence(); break;
                        case 'backward-prepend': this.backwardWords.unshift(word); break;
                        case 'backward-append': this.backwardWords.push(word); break;
                    }
                }
            }

            function getTailwindFilterChipColors(color) {
                const sets = { 'pink': { base: 'bg-white', text: 'text-pink-700', border: 'border-pink-300', hover: 'hover:bg-pink-50 hover:border-pink-400', checked_bg: 'bg-pink-500', checked_text: 'text-white', checked_border: 'border-pink-500' }, 'purple': { base: 'bg-white', text: 'text-purple-700', border: 'border-purple-300', hover: 'hover:bg-purple-50 hover:border-purple-400', checked_bg: 'bg-purple-500', checked_text: 'text-white', checked_border: 'border-purple-500' }, 'blue': { base: 'bg-white', text: 'text-blue-700', border: 'border-blue-300', hover: 'hover:bg-blue-50 hover:border-blue-400', checked_bg: 'bg-blue-500', checked_text: 'text-white', checked_border: 'border-blue-500' }, 'green': { base: 'bg-white', text: 'text-green-700', border: 'border-green-300', hover: 'hover:bg-green-50 hover:border-green-400', checked_bg: 'bg-green-500', checked_text: 'text-white', checked_border: 'border-green-500' }, };
                return sets[color] || { base: 'bg-white', text: 'text-gray-700', border: 'border-gray-300', hover: 'hover:bg-gray-50 hover:border-gray-400', checked_bg: 'bg-gray-500', checked_text: 'text-white', checked_border: 'border-gray-500' };
            }

            function showToast(message, type = 'info') {
                const iconMap = { info: 'fa-info-circle', error: 'fa-times-circle' };
                const colorMap = { info: 'bg-slate-800', error: 'bg-red-600' };
                const toast = document.createElement('div');
                toast.className = `flex items-center w-full max-w-xs p-4 mb-4 text-white ${colorMap[type]} rounded-lg shadow-lg transform transition-all duration-300 translate-y-4 opacity-0`;
                toast.innerHTML = `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"><i class="fas ${iconMap[type]}"></i></div><div class="ms-3 text-sm font-normal">${message}</div>`;
                dom.toastContainer.appendChild(toast);
                requestAnimationFrame(() => toast.classList.remove('translate-y-4', 'opacity-0'));
                setTimeout(() => { toast.classList.add('opacity-0'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000);
            }

            function getTypeFromPath(path) {
                const fileName = path.split('/').pop();
                return fileName.split('.')[0];
            }

            async function initialize() {
                try {
                    let loadedCount = 0;
                    for (const csvPath of csvList) {
                        const response = await fetch(csvPath);
                        if (!response.ok) continue;
                        const data = await response.text();
                        const rows = data.trim().split('\n');
                        const source = getTypeFromPath(csvPath);

                        for (const line of rows) {
                            const row = line.split(',');
                            if (row && row.length > 11 && row[0] && row[11]) {
                                const surface = row[0];
                                const yomi = row[11];
                                const vowels = YU.getVowels(yomi);
                                if (vowels.length > 0) {
                                    const wordObject = { surface, yomi, vowels, source };
                                    if (!wordDetailsMap.has(surface)) wordDetailsMap.set(surface, []);
                                    wordDetailsMap.get(surface).push(wordObject);
                                    forwardTrie.add(vowels.join(''), wordObject);
                                    backwardTrie.add([...vowels].reverse().join(''), wordObject);
                                }
                            }
                        }
                        loadedCount++;
                        dom.loadingProgress.style.width = `${(loadedCount / csvList.length) * 100}%`;
                        dom.loadingText.textContent = `辞書を処理中... (${loadedCount}/${csvList.length})`;
                    }
                    setupModalFilters();
                    dom.loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                    dom.appContainer.classList.remove('opacity-0');
                    dom.startWordInput.focus();
                } catch (error) {
                    console.error('Initialization failed:', error);
                    dom.loadingText.innerHTML = `エラー: 辞書ファイルの読み込みに失敗しました。`;
                    dom.loadingText.classList.add('text-red-500');
                    dom.loadingProgress.parentElement.classList.add('hidden');
                }
            }
            
            function setupModalFilters() {
                dom.searchModal.filterList.innerHTML = '';
                Object.entries(dictionaryConfig).forEach(([key, {name, color}]) => {
                    const colors = getTailwindFilterChipColors(color);
                    const label = document.createElement('label');
                    label.className = `cursor-pointer`;
                    label.innerHTML = `<input type="checkbox" data-filter-type="${key}" class="filter-checkbox sr-only peer" checked><span class="peer-checked:${colors.checked_bg} peer-checked:${colors.checked_text} peer-checked:${colors.checked_border} ${colors.base} ${colors.text} ${colors.border} inline-block text-xs font-medium px-3 py-1.5 rounded-full border-2 transition-all duration-200 ${colors.hover}">${name}</span>`;
                    dom.searchModal.filterList.appendChild(label);
                });
            }

            function render() {
                if (!state) {
                    dom.welcomeMessage.classList.remove('hidden'); dom.palindromeDisplay.classList.add('hidden'); dom.resetButton.classList.add('hidden'); dom.initialControls.classList.remove('hidden'); dom.startWordInput.value = '';
                    return;
                }
                dom.welcomeMessage.classList.add('hidden'); dom.palindromeDisplay.classList.remove('hidden', 'opacity-0'); dom.palindromeDisplay.classList.add('flex'); dom.initialControls.classList.add('hidden'); dom.resetButton.classList.remove('hidden');
                renderSentence(dom.forwardSentenceContainer, state.forwardWords); renderSentence(dom.backwardSentenceContainer, state.backwardWords); renderVowelSequence();
            }

            function renderSentence(container, words) {
                container.innerHTML = words.length > 0 ? '' : '<span class="text-sm text-gray-400 p-2">単語を追加してください</span>';
                words.forEach(word => {
                    const chip = document.createElement('div');
                    chip.className = 'word-chip flex-shrink-0 bg-white border border-gray-300 rounded-lg px-4 py-2 shadow-sm cursor-pointer hover:bg-gray-50 hover:border-indigo-400 transition';
                    chip.innerHTML = `<span class="font-bold text-gray-800">${word.surface}</span><span class="ml-2 text-xs font-mono text-gray-500">${word.yomi}</span>`;
                    chip.title = `母音: ${word.vowels.join('-')}`; container.appendChild(chip);
                });
            }

            function renderVowelSequence() {
                const fwdVowels = state.getForwardVowels(), bwdVowels = state.getBackwardVowels(), bwdTargetVowels = [...state.vowelSequence].reverse();
                dom.vowelSequenceContainer.innerHTML = '';
                state.vowelSequence.forEach((vowel, i) => {
                    const charDiv = document.createElement('div'); charDiv.className = 'vowel-char w-8 h-8 flex items-center justify-center rounded-md text-lg font-mono font-bold'; charDiv.textContent = vowel;
                    const isBwdFilled = i < bwdVowels.length && bwdVowels[i] === bwdTargetVowels[i];
                    charDiv.classList.add(...(isBwdFilled ? 'bg-indigo-500 text-white shadow-md' : 'bg-slate-600 text-slate-300').split(' '));
                    dom.vowelSequenceContainer.appendChild(charDiv);
                });
                dom.forwardVowelCount.textContent = `${fwdVowels.length}母音`; dom.backwardVowelCount.textContent = `${bwdVowels.length}/${state.vowelSequence.length}母音`;
            }

            function handleStart() {
                const word = dom.startWordInput.value.trim(); if (!word) { showToast('開始単語を入力してください。', 'error'); return; }
                const wordData = wordDetailsMap.get(word); if (!wordData || wordData.length === 0) { showToast(`「${word}」は辞書に存在しません。`, 'error'); return; }
                state = new PalindromeState(wordData[0]); render();
            }

            function handleReset() { state = null; render(); }

            function openSearchModal(action) {
                currentSearchContext.action = action; currentSearchContext.rawResults = [];
                const isForwardExpand = action.startsWith('forward');
                dom.searchModal.title.textContent = isForwardExpand ? '文を拡張する単語' : '文を充填する単語';
                dom.searchModal.description.textContent = {'forward-prepend': '文の先頭に追加して母音列を左に拡張します。','forward-append': '文の末尾に追加して母音列を右に拡張します。','backward-prepend': '逆方向の文の先頭に追加します。母音列の末尾に合致します。','backward-append': '逆方向の文の末尾に追加します。母音列の先頭に合致します。'}[action];
                dom.searchModal.vowelLengthSelectorContainer.style.display = isForwardExpand ? 'none' : 'flex'; dom.searchModal.searchBoxContainer.style.display = isForwardExpand ? 'flex' : 'none';
                if (isForwardExpand) { dom.searchModal.searchInput.value = ''; dom.searchModal.queryDisplay.textContent = '任意の単語を検索...'; applyFiltersAndRender(); } else { updateFillSearch(); }
                dom.searchModal.container.classList.remove('opacity-0', 'pointer-events-none'); requestAnimationFrame(() => dom.searchModal.panel.classList.remove('opacity-0', 'scale-95'));
            }

            function applyFiltersAndRender() {
                const activeFilters = new Set(Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.dataset.filterType));
                const filteredResults = currentSearchContext.rawResults.filter(word => activeFilters.has(word.source));
                renderModalResults(filteredResults, (currentSearchContext.queryVowels || []).join(''));
            }

            function updateFillSearch() {
                const numVowels = parseInt(dom.searchModal.vowelLengthSelector.value, 10);
                let queryVowels = [], results = [];
                const bwdVowels = state.getBackwardVowels(), bwdTargetVowels = [...state.vowelSequence].reverse();
                if (currentSearchContext.action === 'backward-append') {
                    queryVowels = bwdTargetVowels.slice(bwdVowels.length, bwdVowels.length + numVowels);
                    if(queryVowels.length > 0) results = forwardTrie.searchPrefix(queryVowels.join(''));
                } else if (currentSearchContext.action === 'backward-prepend') {
                    const fwdVowelStr = state.getForwardVowels().join(''), bwdVowelStr = state.getBackwardVowels().join('');
                    const remainingTarget = [...fwdVowelStr.slice(0, fwdVowelStr.length - bwdVowelStr.length)].reverse().join('');
                    queryVowels = [...remainingTarget.slice(0, numVowels)].reverse();
                    if(queryVowels.length > 0) results = backwardTrie.searchPrefix([...queryVowels].reverse().join(''));
                }
                currentSearchContext.queryVowels = queryVowels; currentSearchContext.rawResults = results;
                dom.searchModal.queryDisplay.textContent = queryVowels.join(' - ') || '（条件なし）';
                applyFiltersAndRender();
            }

            function renderModalResults(results, matchVowels = '') {
                const limit = parseInt(dom.searchModal.modalLimitSelector.value, 10) || 50;
                const uniqueResults = Array.from(new Set(results.map(r => r.surface))).map(surface => results.find(r => r.surface === surface));
                uniqueResults.sort((a,b) => a.vowels.length - b.vowels.length);
                
                const totalCount = uniqueResults.length;
                const limitedResults = uniqueResults.slice(0, limit);

                dom.searchModal.content.innerHTML = '';
                
                if (totalCount === 0) {
                    dom.searchModal.content.innerHTML = '<p class="text-center text-gray-500">条件に合う単語が見つかりません。</p>';
                    return;
                }

                const summary = document.createElement('p');
                summary.className = 'text-sm text-gray-500 mb-4 text-center';
                if (totalCount > limit) {
                    summary.textContent = `全 ${totalCount} 件中、上位 ${limit} 件を表示しています。`;
                } else {
                    summary.textContent = `全 ${totalCount} 件が見つかりました。`;
                }
                dom.searchModal.content.appendChild(summary);

                limitedResults.forEach(word => {
                    const resultCard = document.createElement('button');
                    resultCard.className = 'w-full text-left p-4 bg-gray-50 rounded-lg border-2 border-transparent hover:border-indigo-400 hover:bg-white transition-all duration-200';
                    const colors = getTailwindFilterChipColors(dictionaryConfig[word.source]?.color || 'gray');
                    const vowelStr = word.vowels.join(''), matchLen = matchVowels.length;
                    let highlightedVowels = (vowelStr.startsWith(matchVowels)) ? `<span class="text-indigo-600 font-bold">${word.vowels.slice(0, matchLen).join('')}</span>` + word.vowels.slice(matchLen).join('') : (vowelStr.endsWith(matchVowels)) ? word.vowels.slice(0, vowelStr.length - matchLen).join('') + `<span class="text-indigo-600 font-bold">${word.vowels.slice(vowelStr.length - matchLen).join('')}</span>` : vowelStr;
                    resultCard.innerHTML = `<div class="flex justify-between items-start"><div class="flex-grow"><h4 class="text-lg font-bold text-gray-800">${word.surface} <span class="text-sm font-normal text-gray-500">${word.yomi}</span></h4><p class="font-mono text-gray-600 mt-1">${highlightedVowels}</p></div><div class="flex flex-col items-end gap-2"><span class="text-sm text-gray-500 font-mono">${word.vowels.length}母音</span><span class="${colors.checked_bg} ${colors.checked_text} text-xs font-bold px-2 py-0.5 rounded-full">${dictionaryConfig[word.source]?.name || '不明'}</span></div></div>`;
                    resultCard.onclick = () => selectWord(word); dom.searchModal.content.appendChild(resultCard);
                });
            }
            
            function selectWord(word) {
                if (currentSearchContext.action.startsWith('backward')) {
                    const expectedVowels = currentSearchContext.queryVowels.join(''), actualVowels = word.vowels.join('');
                    if ((currentSearchContext.action === 'backward-append' && !actualVowels.startsWith(expectedVowels)) || (currentSearchContext.action === 'backward-prepend' && !actualVowels.endsWith(expectedVowels))) {
                         showToast('選択された単語の母音が条件に一致しません。', 'error'); return;
                    }
                    word = {...word, vowels: currentSearchContext.queryVowels};
                }
                state.addWord(word, currentSearchContext.action); closeSearchModal(); render();
            }

            function closeSearchModal() {
                dom.searchModal.panel.classList.add('opacity-0', 'scale-95'); dom.searchModal.container.classList.add('opacity-0');
                setTimeout(() => dom.searchModal.container.classList.add('pointer-events-none'), 300);
            }
            
            dom.startButton.addEventListener('click', handleStart);
            dom.startWordInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleStart());
            dom.resetButton.addEventListener('click', handleReset);
            document.querySelectorAll('.add-word-btn').forEach(btn => btn.addEventListener('click', () => openSearchModal(btn.dataset.action)));
            dom.searchModal.closeBtn.addEventListener('click', closeSearchModal);
            dom.searchModal.container.addEventListener('click', (e) => e.target === dom.searchModal.container && closeSearchModal());
            dom.searchModal.vowelLengthSelector.addEventListener('change', updateFillSearch);
            dom.searchModal.searchInput.addEventListener('input', (e) => {
                const term = e.target.value.trim();
                currentSearchContext.rawResults = term ? wordDetailsMap.get(term) || [] : [];
                applyFiltersAndRender();
            });
            dom.searchModal.filterList.addEventListener('change', applyFiltersAndRender);
            dom.searchModal.filterSelectAll.addEventListener('click', () => { document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = true); applyFiltersAndRender(); });
            dom.searchModal.filterDeselectAll.addEventListener('click', () => { document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false); applyFiltersAndRender(); });
            dom.searchModal.modalLimitSelector.addEventListener('change', applyFiltersAndRender);

            initialize();
        });
    </script>
</body>
</html>