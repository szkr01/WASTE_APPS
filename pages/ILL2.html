<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageL3 Explorer V2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            950: '#0a0a0a',
                            900: '#171717',
                            850: '#1f1f1f',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #171717; 
        }
        ::-webkit-scrollbar-thumb {
            background: #404040; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #525252; 
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(23, 23, 23, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #404040;
            border-radius: 2px;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 font-sans h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0 z-20">
        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b border-gray-800">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-layer-group text-white text-sm"></i>
            </div>
            <h1 class="font-semibold text-lg tracking-tight text-white">ImageL3 <span class="text-indigo-400 text-xs align-top">V2</span></h1>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="#" onclick="app.setView('search')" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-md bg-indigo-500/10 text-indigo-400 group transition-all hover:bg-indigo-500/20">
                <i class="fa-solid fa-magnifying-glass w-6 text-center mr-2"></i>
                Search & Gallery
            </a>
            <a href="#" onclick="app.setView('clustering')" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white transition-all">
                <i class="fa-solid fa-object-group w-6 text-center mr-2"></i>
                Clustering
            </a>
            <a href="#" onclick="app.setView('system')" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white transition-all">
                <i class="fa-solid fa-server w-6 text-center mr-2"></i>
                System & Config
            </a>
        </nav>

        <!-- System Status Mini -->
        <div class="p-4 border-t border-gray-800 bg-gray-900/50">
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">System Status</h3>
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400">GPU Load</span>
                        <span class="text-indigo-400 font-mono" id="status-gpu">0%</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-1.5">
                        <div id="bar-gpu" class="bg-indigo-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400">VRAM</span>
                        <span class="text-purple-400 font-mono" id="status-vram">0GB</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-1.5">
                        <div id="bar-vram" class="bg-purple-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs pt-1">
                    <span class="text-gray-500">Queue</span>
                    <span class="text-gray-300 font-mono" id="status-queue">0</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-gray-950">
        
        <!-- Search View -->
        <div id="view-search" class="flex flex-col h-full view-container">
            <!-- Search Context Panel (Glass Header) -->
            <header class="glass z-10 flex-shrink-0 p-4 mx-4 mt-4 rounded-xl shadow-xl shadow-black/20 transition-all duration-300">
                <div class="flex flex-col gap-4">
                    <!-- Top Row: Text Input & Primary Actions -->
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                            <input type="text" id="search-input" placeholder="Search by prompt, tags, or keywords..." 
                                class="w-full bg-gray-900/50 border border-gray-700 text-gray-200 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent block pl-10 p-3 shadow-inner placeholder-gray-600 transition-all">
                        </div>
                        <button onclick="app.executeSearch()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                            <span>Search</span>
                        </button>
                        <button onclick="app.executeRandom()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-700" title="Random Search">
                            <i class="fa-solid fa-shuffle"></i>
                        </button>
                        <button onclick="app.toggleFilters()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-700" title="Advanced Filters">
                            <i class="fa-solid fa-sliders"></i>
                        </button>
                    </div>

                    <!-- Advanced Filters & Image Inputs (Collapsible) -->
                    <div id="filter-panel" class="hidden border-t border-gray-800 pt-4 mt-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            
                            <!-- Col 1: Image Inputs -->
                            <div class="md:col-span-1 border-r border-gray-800 pr-4">
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Image Query</label>
                                <div id="drop-zone" class="border-2 border-dashed border-gray-700 rounded-lg p-4 text-center hover:border-indigo-500 hover:bg-gray-800/30 transition-all cursor-pointer relative" onclick="document.getElementById('file-input').click()">
                                    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                                    <i class="fa-regular fa-image text-2xl text-gray-600 mb-2"></i>
                                    <p class="text-xs text-gray-400">Drop images or click to upload</p>
                                </div>
                                <div id="image-query-list" class="mt-3 space-y-2 max-h-40 overflow-y-auto pr-1">
                                    <!-- Image query items will be injected here -->
                                </div>
                            </div>

                            <!-- Col 2: Text Filters -->
                            <div class="md:col-span-1 space-y-3">
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Refine</label>
                                <div>
                                    <input type="text" id="filter-positive" placeholder="Positive Prompt Filter" class="w-full bg-gray-900 border border-gray-700 text-xs rounded p-2">
                                </div>
                                <div>
                                    <input type="text" id="filter-negative" placeholder="Negative Prompt Filter" class="w-full bg-gray-900 border border-gray-700 text-xs rounded p-2">
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <input type="checkbox" id="filter-deleted" class="rounded bg-gray-900 border-gray-700 text-indigo-600 focus:ring-indigo-500">
                                    <label for="filter-deleted" class="text-xs text-gray-400">Include Deleted</label>
                                </div>
                            </div>

                            <!-- Col 3: Sliders -->
                            <div class="md:col-span-1">
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Balance</label>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between text-xs mb-1">
                                            <span class="text-gray-400">Vector vs Meta (Alpha)</span>
                                            <span id="val-alpha" class="text-indigo-400">0.5</span>
                                        </div>
                                        <input type="range" id="filter-alpha" min="0" max="1" step="0.1" value="0.5" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-xs mb-1">
                                            <span class="text-gray-400">Threshold</span>
                                            <span id="val-threshold" class="text-indigo-400">0.0</span>
                                        </div>
                                        <input type="range" id="filter-threshold" min="0" max="1" step="0.1" value="0" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Gallery Area -->
            <div id="gallery-container" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 pb-20">
                    <!-- Gallery Items injected here -->
                </div>
                <!-- Empty State -->
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50">
                    <i class="fa-solid fa-magnifying-glass text-6xl mb-4"></i>
                    <p class="text-lg font-light">Start exploring your library</p>
                </div>
                <!-- Loading State -->
                <div id="gallery-loader" class="hidden h-64 flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
        </div>

        <!-- Clustering View (Placeholder) -->
        <div id="view-clustering" class="hidden flex-col h-full p-8 text-center justify-center view-container">
            <div class="max-w-md mx-auto">
                <i class="fa-solid fa-object-group text-6xl text-gray-700 mb-6"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Clustering</h2>
                <p class="text-gray-400 mb-6">Group search results by similarity.</p>
                <button onclick="app.triggerClustering()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Run Clustering</button>
            </div>
            <div id="clustering-results" class="mt-8 text-left"></div>
        </div>

        <!-- System View (Placeholder) -->
        <div id="view-system" class="hidden flex-col h-full p-8 overflow-y-auto view-container">
            <h2 class="text-2xl font-bold text-white mb-6">System Configuration</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-medium text-white mb-4">Directories</h3>
                    <div id="directory-tree" class="text-sm text-gray-300 font-mono pl-2">Loading...</div>
                </div>
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-medium text-white mb-4">Raw Status</h3>
                    <pre id="system-raw-status" class="text-xs text-green-400 bg-black/50 p-4 rounded-lg overflow-x-auto"></pre>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal (Detail View) -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="app.closeModal()"></div>
        
        <!-- Modal Content -->
        <div class="absolute inset-4 md:inset-10 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row fade-in">
            <!-- Close Button -->
            <button onclick="app.closeModal()" class="absolute top-4 right-4 z-10 bg-black/50 hover:bg-red-500/80 text-white w-8 h-8 rounded-full flex items-center justify-center transition-colors">
                <i class="fa-solid fa-times"></i>
            </button>

            <!-- Left: Image Preview -->
            <div class="w-full md:w-2/3 h-1/2 md:h-full bg-black/50 flex items-center justify-center relative p-4 group">
                <img id="modal-image" src="" alt="Detail" class="max-h-full max-w-full object-contain shadow-lg rounded-lg">
                <!-- Image Actions -->
                <div class="absolute bottom-6 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <a id="btn-download" href="#" download class="bg-gray-800/90 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition-colors">
                        <i class="fa-solid fa-download mr-1"></i> Download
                    </a>
                    <button onclick="app.useAsQuery()" class="bg-gray-800/90 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition-colors">
                        <i class="fa-solid fa-search mr-1"></i> Find Similar
                    </button>
                    <button onclick="app.deleteCurrentFile()" class="bg-gray-800/90 text-red-400 px-4 py-2 rounded-lg text-sm hover:bg-red-900/50 hover:text-red-200 transition-colors">
                        <i class="fa-solid fa-trash mr-1"></i> Delete
                    </button>
                </div>
            </div>

            <!-- Right: Info & Metadata -->
            <div class="w-full md:w-1/3 h-1/2 md:h-full bg-gray-900 border-l border-gray-800 flex flex-col">
                <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                    
                    <!-- Basic Info -->
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-white truncate" id="modal-filename">Filename.png</h2>
                        <p class="text-xs text-gray-500 font-mono mt-1 break-all" id="modal-path">/path/to/file</p>
                        <div class="flex gap-4 mt-3 text-sm text-gray-400">
                            <span id="modal-res"><i class="fa-regular fa-image mr-1"></i> -</span>
                            <span id="modal-size"><i class="fa-solid fa-database mr-1"></i> -</span>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-3">Tags & Confidence</h3>
                        <div id="modal-tags" class="flex flex-wrap gap-1.5">
                            <!-- Tags injected here -->
                        </div>
                    </div>

                    <!-- Generation Params -->
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-3">Generation Info</h3>
                        <div id="modal-generation" class="space-y-2 text-xs text-gray-300">
                            <!-- Generation info injected here -->
                        </div>
                    </div>

                    <!-- Prompt -->
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-2">Prompt</h3>
                        <div class="bg-gray-800 rounded p-3 text-xs text-gray-300 relative group">
                            <p id="modal-prompt" class="max-h-24 overflow-y-auto">No prompt data.</p>
                            <button onclick="app.copyPrompt()" class="absolute top-2 right-2 text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const API_HOST = 'http://localhost:8001';

        /**
         * Utility Functions
         */
        const utils = {
            formatBytes: (bytes, decimals = 2) => {
                if (!+bytes) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
            },
            showToast: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-600' : 'bg-indigo-600';
                el.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 text-sm min-w-[250px] fade-in transform transition-all`;
                el.innerHTML = `
                    <i class="fa-solid ${type === 'error' ? 'fa-circle-exclamation' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                `;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                    setTimeout(() => el.remove(), 300);
                }, 4000);
            },
            fileToBase64: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            },
            // カラー計算: 信頼度に応じて色を濃くする
            getConfidenceStyle: (confidence) => {
                const conf = parseFloat(confidence);
                const isHigh = conf > 0.8;
                const alpha = Math.max(0.15, conf * 0.9); // 透明度調整
                // Indigo base (99, 102, 241)
                return `background-color: rgba(99, 102, 241, ${alpha}); color: ${conf > 0.6 ? '#fff' : 'rgba(255,255,255,0.7)'}; border: 1px solid rgba(165, 180, 252, ${conf * 0.5})`;
            }
        };

        /**
         * API Client
         */
        const api = {
            async fetch(endpoint, options = {}) {
                try {
                    const url = `${API_HOST}${endpoint}`;
                    const res = await fetch(url, options);
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail ? JSON.stringify(err.detail) : `HTTP ${res.status}`);
                    }
                    if (res.status === 204) return null;
                    return await res.json();
                } catch (e) {
                    utils.showToast(e.message, 'error');
                    console.error("API Error:", e);
                    throw e;
                }
            },
            search: (body) => api.fetch('/api/v1/search/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }),
            random: () => api.fetch('/api/v1/search/random?limit=50'),
            getFileInfo: (id) => api.fetch(`/api/v1/files/${id}/info`),
            getAnalysis: (id) => api.fetch(`/api/v1/analysis/${id}`),
            deleteFile: (id) => api.fetch(`/api/v1/files/${id}`, { method: 'DELETE' }),
            getStatus: () => api.fetch('/api/v1/system/status'),
            getDirectories: () => api.fetch('/api/v1/system/directories'),
            clustering: (body) => api.fetch('/api/v1/clustering/group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
        };

        /**
         * Application State & Logic
         */
        const app = {
            state: {
                currentView: 'search',
                queryImages: [], // { id, data, weight, preview }
                searchResults: [],
                currentFile: null,
                systemInterval: null
            },

            init() {
                this.setupEventListeners();
                this.startSystemMonitor();
                this.setView('search');
                // 初期ロードでランダム表示
                this.executeRandom();
            },

            setupEventListeners() {
                // Drag & Drop
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('bg-indigo-900/20', 'border-indigo-500');
                });
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('bg-indigo-900/20', 'border-indigo-500');
                });
                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('bg-indigo-900/20', 'border-indigo-500');
                    const files = e.dataTransfer.files;
                    if (files.length) this.handleImageUpload(files);
                });
                fileInput.addEventListener('change', (e) => {
                    if (fileInput.files.length) this.handleImageUpload(fileInput.files);
                });

                // Sliders
                document.getElementById('filter-alpha').addEventListener('input', (e) => {
                    document.getElementById('val-alpha').textContent = e.target.value;
                });
                document.getElementById('filter-threshold').addEventListener('input', (e) => {
                    document.getElementById('val-threshold').textContent = e.target.value;
                });

                // Enter key search
                document.getElementById('search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.executeSearch();
                });
            },

            async handleImageUpload(files) {
                for (let file of files) {
                    try {
                        const base64 = await utils.fileToBase64(file);
                        this.state.queryImages.push({
                            type: 'base64',
                            data: base64.split(',')[1], // remove prefix
                            weight: 1.0,
                            preview: base64
                        });
                    } catch (e) {
                        console.error(e);
                    }
                }
                this.renderQueryImages();
            },

            renderQueryImages() {
                const container = document.getElementById('image-query-list');
                container.innerHTML = '';
                this.state.queryImages.forEach((img, idx) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-2 bg-gray-800 p-2 rounded';
                    el.innerHTML = `
                        <img src="${img.preview}" class="w-10 h-10 object-cover rounded border border-gray-600">
                        <div class="flex-1">
                            <div class="flex justify-between text-[10px] text-gray-400">
                                <span>Weight</span>
                                <span>${img.weight}</span>
                            </div>
                            <input type="range" min="0.1" max="2.0" step="0.1" value="${img.weight}" 
                                oninput="app.updateImageWeight(${idx}, this.value)" class="w-full h-1 bg-gray-600 rounded">
                        </div>
                        <button onclick="app.removeQueryImage(${idx})" class="text-gray-500 hover:text-red-400 p-1">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    `;
                    container.appendChild(el);
                });
            },

            updateImageWeight(idx, val) {
                this.state.queryImages[idx].weight = parseFloat(val);
                this.renderQueryImages(); // Re-render to update text, inefficient but safe
            },

            removeQueryImage(idx) {
                this.state.queryImages.splice(idx, 1);
                this.renderQueryImages();
            },

            toggleFilters() {
                const panel = document.getElementById('filter-panel');
                panel.classList.toggle('hidden');
            },

            setView(viewName) {
                this.state.currentView = viewName;
                document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('flex'));
                
                const target = document.getElementById(`view-${viewName}`);
                target.classList.remove('hidden');
                target.classList.add('flex');

                // Nav Highlight
                document.querySelectorAll('.nav-item').forEach(el => {
                    // Reset basic styles
                    el.classList.remove('bg-indigo-500/10', 'text-indigo-400');
                    el.classList.add('text-gray-400');
                });
                // Simple logic for demo, better to use ID based selection
                if(viewName === 'system') this.loadSystemView();
            },

            async executeSearch() {
                const text = document.getElementById('search-input').value;
                const alpha = parseFloat(document.getElementById('filter-alpha').value);
                const pos = document.getElementById('filter-positive').value;
                const neg = document.getElementById('filter-negative').value;
                const deleted = document.getElementById('filter-deleted').checked;

                const loader = document.getElementById('gallery-loader');
                const grid = document.getElementById('gallery-grid');
                const empty = document.getElementById('empty-state');
                
                grid.innerHTML = '';
                empty.classList.add('hidden');
                loader.classList.remove('hidden');

                const payload = {
                    vector: {
                        enabled: true,
                        text: text || null,
                        images: this.state.queryImages.map(img => ({
                            type: img.type,
                            data: img.data,
                            weight: img.weight
                        })),
                        config: { alpha: alpha, beta: 1.0 - alpha }
                    },
                    meta: {
                        enabled: true,
                        positive_prompt: pos || null,
                        negative_prompt: neg || null,
                        include_deleted: deleted
                    },
                    pagination: { limit: 50 }
                };

                try {
                    const res = await api.search(payload);
                    this.state.searchResults = res.items;
                    this.renderGallery(res.items);
                } catch (e) {
                    empty.classList.remove('hidden');
                } finally {
                    loader.classList.add('hidden');
                }
            },

            async executeRandom() {
                const loader = document.getElementById('gallery-loader');
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                loader.classList.remove('hidden');
                
                try {
                    const res = await api.random();
                    this.state.searchResults = res.items;
                    this.renderGallery(res.items);
                } catch (e) {
                    console.error(e);
                } finally {
                    loader.classList.add('hidden');
                }
            },

            renderGallery(items) {
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                
                if (!items || items.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }

                items.forEach(item => {
                    const el = document.createElement('div');
                    const imgUrl = `${API_HOST}/api/v1/files/${item.id}/content?size=512`;
                    
                    // Masonry的なカード
                    el.className = 'relative aspect-[3/4] group bg-gray-900 rounded-lg overflow-hidden border border-gray-800 hover:border-indigo-500/50 transition-all cursor-pointer';
                    el.onclick = () => this.openModal(item.id);

                    el.innerHTML = `
                        <img src="${imgUrl}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="absolute bottom-0 p-3 w-full">
                                <div class="text-xs text-gray-300 font-mono truncate">${item.path.split(/[\\/]/).pop()}</div>
                                ${item.score ? `<div class="text-[10px] text-indigo-400">Score: ${item.score.toFixed(4)}</div>` : ''}
                            </div>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            },

            async openModal(id) {
                const modal = document.getElementById('detail-modal');
                const img = document.getElementById('modal-image');
                
                // Reset content
                img.src = '';
                document.getElementById('modal-tags').innerHTML = '<span class="text-gray-500 text-xs">Loading analysis...</span>';
                
                modal.classList.remove('hidden');
                
                try {
                    // Parallel fetch
                    const [info, analysis] = await Promise.all([
                        api.getFileInfo(id),
                        api.getAnalysis(id)
                    ]);

                    this.state.currentFile = { info, analysis };

                    // Update UI
                    img.src = `${API_HOST}/api/v1/files/${id}/content`; // Full size
                    document.getElementById('modal-filename').textContent = info.path.split(/[\\/]/).pop();
                    document.getElementById('modal-path').textContent = info.path;
                    document.getElementById('modal-res').innerHTML = `<i class="fa-regular fa-image mr-1"></i> ${info.width}x${info.height}`;
                    document.getElementById('modal-size').innerHTML = `<i class="fa-solid fa-database mr-1"></i> ${utils.formatBytes(info.size_bytes)}`;
                    document.getElementById('btn-download').href = `${API_HOST}/api/v1/files/${id}/content`;

                    // Render Tags
                    const tagsContainer = document.getElementById('modal-tags');
                    tagsContainer.innerHTML = '';
                    if (analysis.inference && analysis.inference.tags) {
                        analysis.inference.tags.forEach(tag => {
                            const span = document.createElement('span');
                            span.className = 'px-2 py-0.5 rounded text-[10px] border cursor-pointer hover:brightness-110 transition-all';
                            span.style = utils.getConfidenceStyle(tag.confidence);
                            span.textContent = `${tag.name} (${Math.round(tag.confidence*100)}%)`;
                            span.onclick = () => {
                                document.getElementById('search-input').value += ` ${tag.name}`;
                                utils.showToast(`Added tag: ${tag.name}`);
                            };
                            tagsContainer.appendChild(span);
                        });
                    }

                    // Render Generation Info
                    const genContainer = document.getElementById('modal-generation');
                    genContainer.innerHTML = '';
                    const gen = analysis.generation;
                    if (gen) {
                        const items = [
                            { l: 'Model', v: gen.base_model },
                            { l: 'Steps', v: gen.steps },
                            { l: 'Sampler', v: gen.sampler },
                            { l: 'CFG', v: gen.cfg_scale },
                            { l: 'Seed', v: gen.seed },
                            { l: 'Tool', v: gen.tool }
                        ];
                        items.forEach(i => {
                            if(i.v) genContainer.innerHTML += `<div class="flex justify-between border-b border-gray-800 pb-1 mb-1"><span>${i.l}</span><span class="font-mono text-gray-400">${i.v}</span></div>`;
                        });
                        document.getElementById('modal-prompt').textContent = gen.positive_prompt || "No positive prompt.";
                    }

                } catch (e) {
                    utils.showToast("Failed to load details", "error");
                    console.error(e);
                }
            },

            closeModal() {
                document.getElementById('detail-modal').classList.add('hidden');
                this.state.currentFile = null;
            },

            async deleteCurrentFile() {
                if(!this.state.currentFile) return;
                if(!confirm("Are you sure you want to delete this file?")) return;
                
                try {
                    await api.deleteFile(this.state.currentFile.info.id);
                    utils.showToast("File deleted");
                    this.closeModal();
                    this.executeSearch(); // Refresh list
                } catch(e) {
                    // error handled in api wrapper
                }
            },

            async useAsQuery() {
                if(!this.state.currentFile) return;
                const id = this.state.currentFile.info.id;
                
                // Add current image ID to query images
                this.state.queryImages.push({
                    type: 'id',
                    data: id,
                    weight: 1.0,
                    preview: `${API_HOST}/api/v1/files/${id}/content?size=512`
                });
                this.renderQueryImages();
                this.closeModal();
                utils.showToast("Image added to search query");
            },

            copyPrompt() {
                const text = document.getElementById('modal-prompt').textContent;
                navigator.clipboard.writeText(text);
                utils.showToast("Prompt copied to clipboard");
            },

            async triggerClustering() {
                // Use current search result IDs
                const ids = this.state.searchResults.map(i => i.id);
                if (ids.length < 2) {
                    utils.showToast("Need more results to cluster", "error");
                    return;
                }

                utils.showToast("Clustering started...");
                try {
                    const res = await api.clustering({
                        ids: ids,
                        threshold: 0.7,
                        min_group_size: 2
                    });
                    
                    const container = document.getElementById('clustering-results');
                    container.innerHTML = '';
                    
                    res.groups.forEach(group => {
                        const row = document.createElement('div');
                        row.className = 'mb-6 p-4 bg-gray-900 rounded-xl border border-gray-800';
                        row.innerHTML = `<h4 class="text-sm font-bold text-indigo-400 mb-2">Group ${group.label} (${group.items.length} items)</h4>`;
                        
                        const imgs = document.createElement('div');
                        imgs.className = 'flex gap-2 overflow-x-auto pb-2 custom-scrollbar';
                        group.items.forEach(id => {
                            imgs.innerHTML += `
                                <img src="${API_HOST}/api/v1/files/${id}/content?size=512" 
                                class="w-24 h-24 object-cover rounded-lg flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
                                onclick="app.openModal('${id}')">
                            `;
                        });
                        row.appendChild(imgs);
                        container.appendChild(row);
                    });

                } catch(e) {
                    console.error(e);
                }
            },

            startSystemMonitor() {
                const update = async () => {
                    try {
                        const status = await api.getStatus();
                        // GPU
                        document.getElementById('status-gpu').textContent = status.resources.gpu_usage_pct + '%';
                        document.getElementById('bar-gpu').style.width = status.resources.gpu_usage_pct + '%';
                        
                        // VRAM
                        const vram = (status.resources.vram_usage_mb / 1024).toFixed(1);
                        document.getElementById('status-vram').textContent = vram + 'GB';
                        // Assuming 24GB max for visualization scale
                        const vramPct = Math.min((status.resources.vram_usage_mb / 24576) * 100, 100); 
                        document.getElementById('bar-vram').style.width = vramPct + '%';

                        document.getElementById('status-queue').textContent = status.queue.pending_count;
                        
                        // Raw dump for system view
                        const rawEl = document.getElementById('system-raw-status');
                        if (rawEl) rawEl.textContent = JSON.stringify(status, null, 2);

                    } catch(e) {
                        // Silent fail for polling
                    }
                };
                update();
                this.state.systemInterval = setInterval(update, 2000);
            },

            async loadSystemView() {
                const treeEl = document.getElementById('directory-tree');
                try {
                    const dirs = await api.getDirectories();
                    // 簡易的なツリー表示（再帰実装が必要だがここでは簡略化）
                    // API仕様では「任意のキーと値」となっているため、実際の構造に合わせて適応が必要
                    // ここではダミー的なJSONダンプを行う
                    treeEl.textContent = JSON.stringify(dirs, null, 2);
                } catch(e) {
                    treeEl.textContent = "Failed to load directories.";
                }
            }
        };

        // Boot
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>